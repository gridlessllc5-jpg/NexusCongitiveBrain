<analysis>**original_problem_statement:**
The user wants to build a standalone, high-intelligence NPC service for a game named Fractured Survival. The service must be decoupled from Unreal Engine, featuring a Double-Pass cognitive architecture and persistent memory, controllable via an API.

The project has since expanded to include:
*   **Advanced Voice Features**: Unique, personality-driven TTS voices (ElevenLabs), voice auto-playing, and STT for player microphone input (Whisper).
*   **User Authentication**: A full JWT-based authentication system (via MongoDB) for web UI and Unreal Engine clients.
*   **UI/UX Overhaul**: A complete visual redesign with a mandatory login page, a dark post-apocalyptic theme, and a voice visualizer.
*   **Performance Optimization**: A move from a standard HTTP request/response model to a real-time WebSocket-based architecture to reduce latency for the Unreal Engine client.
*   **Deployment Readiness**: The application must be deployable as a single container, with all branding removed.

**User's preferred language**: The user communicates in English. The next agent MUST respond in English.

**what currently exists?**
The application is a monolithic FastAPI service that combines the web backend and the NPC Brain service. This was a critical change to solve deployment issues.
1.  **Unified Backend ():** A single FastAPI service that handles all functionality:
    *   **User Authentication:** A JWT-based system using MongoDB for user data.
    *   **Embedded NPC Service:** The  logic is no longer a separate service but is now directly imported and mounted within the main backend. This solves previous container networking issues during deployment.
    *   **API Endpoints:** Provides both HTTP REST endpoints and a new (in-progress) WebSocket endpoint for real-time communication.
2.  **NPC Brain Logic ():** Contains all the cognitive, memory, and world-simulation modules.
    *   : Core AI logic using GPT-5.2.
    *   : Manages TTS with ElevenLabs, now using the faster  model and supporting WAV format.
    *   : A new, empty file intended to house the WebSocket logic.
3.  **Frontend ():** A React-based dashboard for interacting with the system, now free of all Emergent branding.

**Last working item**:
-   **Last item agent was working:** The agent began a major architectural enhancement by adding a WebSocket endpoint. This was a direct response to the user's feedback that the HTTP-based API felt too slow for a real-time game in Unreal Engine. The goal is to provide a persistent, low-latency communication channel for dialogue, audio streaming, and real-time world events.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** backend testing agent. This is a major backend change. After implementing the WebSocket logic in , a custom Python script will be needed to act as a client for testing the connection. Following that, a full run with the backend testing agent is crucial to ensure no regressions have been introduced to the existing HTTP endpoints.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
There are no outstanding bugs. All previously reported issues (503 errors, DB errors, incorrect voice assignment) were resolved in this session. The sole focus is on completing the WebSocket feature.

**In progress Task List**:
-   **Task 1: Complete WebSocket Implementation** (Priority: P0)
    -   **Where to resume:** The implementation needs to be built out in . This file is currently empty. The agent needs to add logic for:
        1.  Managing client connections.
        2.  A message router to handle incoming JSON messages (e.g., ).
        3.  Handlers for each message type that call the corresponding functions in , , etc.
        4.  Streaming responses back to the client (e.g., audio chunks, NPC dialogue).
    -   **What will be achieved with this?** A fully functional, low-latency, real-time communication layer for the Unreal Engine client, improving gameplay fluidity.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on something:** No.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P0) Update Documentation for WebSockets:** After implementation, the  must be updated with the new WebSocket API details, message formats, and integration examples for Unreal Engine.
    -   **(P1) Create an embed-friendly UI:** The user expressed interest in using the Web Browser widget in Unreal. A simplified version of the UI could be created for this purpose.
-   **Future Tasks:**
    -   **(P2) UI for Voice Cloning:** Implement a frontend interface for the existing  endpoint.
    -   **(P3) Ambient Sound Integration:** A user-suggested enhancement to add background sounds during NPC interactions.

**Completed work in this session**
-   **Deployment Architecture Overhaul:**
    -   **Resolved all 503/502 errors** by embedding the  service directly into the  server (). This eliminates multi-container networking issues in the production environment.
    -   Updated all API proxy routes to use the internal, embedded service, ensuring consistent behavior between preview and deployment.
-   **Database and Deployment Fixes:**
    -   Fixed a recurring  error in MongoDB by implementing an automatic migration script in  that cleans the database on startup.
    -   Corrected the  file to allow  files to be included in deployments, ensuring API keys are available in production.
    -   Consolidated all necessary environment variables into .
-   **Voice System Enhancements:**
    -   **Added WAV Format Support:** Modified the voice generation endpoint () to output WAV audio when requested (), for better compatibility with Unreal Engine.
    -   **Improved Voice Speed:** Switched the ElevenLabs model from  to the much faster  at the user's request.
    -   **Fixed Voice Assignment Bug:** Corrected an issue where female NPCs were assigned male voices. Voice assignment now happens automatically during NPC initialization with respect to gender.
-   **Branding Removal:**
    -   Removed all user-facing Emergent branding, logos, tracking scripts, and meta tags from  and .
-   **API Documentation:**
    -   Created comprehensive documentation () detailing all API endpoints, data models, and integration patterns for Unreal Engine.

**Earlier issues found/mentioned but not fixed**
-   None.

**Known issue recurrence from previous fork**
-   The  error recurred but was traced to a new root cause (deployment architecture) which has now been definitively fixed by embedding the  within the .

**Code Architecture**


**Key Technical Concepts**
-   **Service Embedding:** The  FastAPI app is now mounted as a sub-application within the main  app. This creates a single-process, single-container service that is compatible with the deployment environment.
-   **WebSockets:** A new usage: websockets [--version | <uri>] library has been added to facilitate real-time, bi-directional communication, intended to replace the slower HTTP polling for game clients.
-   **Audio Processing:** The  library (with  system dependency) was added to handle on-the-fly conversion of MP3 audio from ElevenLabs to WAV format for Unreal Engine.
-   **Database Migration:** An automatic, on-startup migration was added to  to fix data integrity issues in the deployed database.

**key DB schema**
-   **MongoDB ( service):**
    -   :  (email is now optional)

**changes in tech stack**
-   usage: websockets [--version | <uri>] library added for real-time communication.
-    library added for audio conversion.
-    installed as a system dependency for .

**All files of reference**
-   : Heavily modified to embed the NPC service and correctly route all API calls internally.
-   : Modified to add the  WebSocket endpoint and support for WAV format in the voice generation endpoint.
-   : New file created to contain the WebSocket implementation logic.
-   : The ElevenLabs model was updated to .
-   : Updated with a database migration function in .
-   : All Emergent branding and tracking scripts were removed.
-   : Updated to allow  files for deployment.
-   : Now contains all environment variables for both backend and NPC system.
-   : New comprehensive documentation file.

**Areas that need refactoring**:
-   The main  file has become a large monolith due to the service embedding. The numerous API routing functions that act as internal proxies could be abstracted into a cleaner, more dynamic routing class to reduce code duplication.

**key api endpoints**
-   : Authenticates a player from Unreal Engine.
-   : The primary endpoint for NPC interaction (HTTP).
-   : Generates TTS audio, now supports .
-   : A full-cycle endpoint for STT -> AI -> TTS.
-   : **(New, In-Progress)** The WebSocket endpoint for real-time game communication.

**Critical Info for New Agent**
-   **The architecture is now a single, unified service.** The  is embedded into the . Do not treat them as separate services. All API calls, including those that were previously proxied, are now handled internally within the same process.
-   **The immediate priority is to build out the WebSocket functionality.** The foundation is laid (library installed, endpoint created, handler file present), but the core logic in  needs to be written from scratch. Follow the plan discussed with the user to implement features like NPC actions and voice streaming over WebSockets.
-   **Existing HTTP endpoints must remain functional.** The WebSocket API is an *addition*, not a replacement for now. All changes must be tested to prevent regressions.

**documents and test reports created in this job**
-   
-   
-   

**Last 10 User Messages and any pending HUMAN messages**
1.   - User confirms functionality but reports performance issues. (Status: Addressed by switching to Turbo TTS and planning WebSockets).
2.   - User clarifies that audio latency is the main concern. (Status: Addressed).
3.   - User asks about performance. (Status: Addressed, agent switched to a faster model).
4.   - User confirms to switch to the faster Turbo TTS model. (Status: Completed).
5.   - User asks about feature parity. (Status: Addressed, Turbo model has more language support).
6.   - User initiates the discussion for a major architectural change. (Status: Addressed).
7.   - User agrees to the WebSocket plan but cautions about testing. (Status: Addressed, agent proposed a phased plan).
8.   - User requests to implement the full WebSocket system in one go. (Status: Acknowledged, currently in progress).
9.  - User sees an error during the process and asks the agent to continue.
10.  - User reports a regression where the NPC voice was incorrect. (Status: Resolved).

**Project Health Check:**
-   **Broken:** None.
-   **Mocked:** None.
-   **In Progress:** The WebSocket implementation is partially complete.

**3rd Party Integrations**
-   **OpenAI GPT-5.2 (Text Generation):** Via  (uses Emergent LLM Key).
-   **ElevenLabs (Text-to-Speech):**  SDK, now configured for the  model (requires User API Key).
-   **OpenAI Whisper (Speech-to-Text):** Via  (uses Emergent LLM Key).
-   **pydub:** New library for audio manipulation.

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** YES (to identify the deployment architecture issue).
-   **Test files created:** [ ]
-   **Known regressions:** A voice assignment regression occurred during the session but was fixed.

**Credentials to test flow:**
-   User accounts can be created via the registration form. Use any username/password (e.g.,  / ).

**What agent forgot to execute**
-   The agent is in the middle of a large task (WebSocket implementation) and has not forgotten anything. The previous session ended right after creating the foundational files for this feature.</analysis>
